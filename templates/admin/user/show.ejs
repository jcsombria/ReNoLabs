<div class="d-flex m-2">
    <button class="me-auto btn btn-success" onclick="getData()">Guardar cambios</button>
    <div>
        <label for="formFile" class="form-label">Importar desde archivo...</label>
        <input class="form-control" type="file" name="formFile" id="formFile" accept=".csv" onchange="onFileChanged(this.files[0])">
    </div>
</div>
<table class="table table-sm table-striped table-hover table-bordered border-primary" id="usersTable">
    <thead class="table-primary">
      <tr>
        <th scope="col">#</th>
        <th scope="col">Usuario</th>
        <th scope="col">Nombre Completo</th>
        <th scope="col">Contraseña</th>
        <th scope="col">E-mail</th>
        <th scope="col">Permisos</th>
      </tr>
    </thead>
    <tbody>
        <% users.forEach(function(user){ %>
            <tr>
                <th scope="row"><%= user.id %></th>
                <td><input type="text" value="<%= user.username %>" title="Identificador de usuario." /></td>
                <td><input type="text" value="<%= user.displayName %>" title="Nombre completo del usuario." /></td>
                <td><input type="text" value="<%= user.password %>" title="Contraseña del usuario." /></td>
                <td><input type="text" value="<%= JSON.stringify(user.emails) %>" title="Correo electrónico"/></td>
                <td><input type="text" value="<%= user.permissions %>" title="Permisos del usuario: {ADMIN|RO|USER}. Puede introducir varios, separados por comas."/></td>
            </tr>
        <% }); %>
    </tbody>
</table>

<script>
    onFileChanged = function(f) {
        var reader = new FileReader();
        reader.onload = function() {
            let lines = reader.result.split('\n');
            let users = lines.map((l) => {
                let fields = l.split(',');
                try {
                    fields[5] = fields[5].replaceAll(';', ',');
                    return fields;
                } catch(e) {}
            }).slice(1);
            fillTable(users);
        };
        reader.readAsText(f);
    }

    getData = function() {
        var table = document.getElementById("usersTable");
        // Gather users.
        let users = [];
        for (var i = 1; i < table.rows.length; i++) {
            var cells = table.rows.item(i).cells;
            let emails = JSON.parse(cells[4].childNodes[0].value);
            users.push({
                id : cells[0].innerHTML,
                username : cells[1].childNodes[0].value,
                displayName : cells[2].childNodes[0].value,
                password : cells[3].childNodes[0].value,
                emails : emails,
                permissions : cells[5].childNodes[0].value.split(','),
            });
        }

        $.ajax({
            type: 'POST',
            url: '/admin/users/set',
            headers: {'Content-Type': 'application/json'},
            data: JSON.stringify(users),
            processData: false,
            success: function(data) {
                alert(JSON.stringify(data));
                location.reload();
            },
        });
    }

    fillTable = function(users) {
        let table = document.getElementById("usersTable");
        for (var i = table.rows.length-1; i > 0 ; i--) {
            table.rows[i].remove();
        }
        for(var i=0; i<users.length; i++) {
            let u = users[i];
            table.insertRow(i);
            var cells = table.rows.item(i).cells;
            cells[0].innerHTML = u[0];
            for (var j=1; j<cells.length; j++) {
                cells[j].childNodes[0].value = u[j];
            }
            // cells[2].childNodes[0].value = u[2];
            // cells[3].childNodes[0].value = u[3];
            // cells[4].childNodes[0].value = u[4];
            // cells[5].childNodes[0].value = u[5];
        };
    }

</script>